# **gRPC PubSub Service**

## **Описание**

Этот проект реализует gRPC-сервис для публикации и подписки на события с использованием пакета `subpub`. Сервис предоставляет следующие возможности:
- **Публикация событий**: Отправка сообщений по указанному ключу.
- **Подписка на события**: Получение потока событий по указанному ключу.

Протокол общения основан на gRPC, с использованием protobuf-схемы, представленной ниже:

```proto
syntax = "proto3";

import "google/protobuf/empty.proto";

service PubSub {
  // Подписка (сервер отправляет поток событий)
  rpc Subscribe(SubscribeRequest) returns (stream Event);

  // Публикация (классический запрос-ответ)
  rpc Publish(PublishRequest) returns (google.protobuf.Empty);
}

message SubscribeRequest {
  string key = 1;
}

message PublishRequest {
  string key = 1;
  string data = 2;
}

message Event {
  string data = 1;
}
```
## Метод Subscribe
  - **Клиент посылает запрос и сервер отправляет поток событий**
  - **Создаем отдельную горутину через пакет subpub, которая обрабатывает передаваемые сообщения**
  - **При разрыве соединения подписка удаляется**
### Пример запроса
```
{
    "key": "sint sed adipisicing minim"
}
```
### Пример ответа
```
{}
```
## Метод Publish
  - **Клиент посылает запрос на сервер и отправляет переданное сообщение в ко всем подписчикам**
### Пример запроса
```
{
    "data": "dolor",
    "key": "amet id proident anim consequat"
}
```
## Особенности
 - **Dependency injection (При проброске сервиса subpub в структуру ServiceAPI, которая имплементирует все методы сервера**
 - **Проект логгируется на всех этапах: при запуске, выполнении бизнес-логики, окончании работы**
 - **Graceful shutdown при окончании работы проекта, сервер перестает принимать запросы и дает время завершится оставшимся**
 - **Используется файл конфигурации, что позволяет конфигурировать приложение**
## Как собрать сервис
 - **Так как сервис очень простой то Docker не используется**
 - **При запуске приложения необходимо в виде флага --config указать путь до конфигурационного файла**
### Запуск приложения:

```
go run ./cmd/main.go --config=./config/local.yaml
```
# **Описание пакета SubPub**

Пакет `SubPub` предоставляет реализацию механизма публикации и подписки на сообщения (Pub/Sub) с использованием каналов Go. Он позволяет создавать асинхронные подписки на события по ключу, а также публиковать события с возможностью доставки нескольким подписчикам.

## **Как работает SubPub**

1. **Подписка**
   - Метод `Subscribe` позволяет клиентам подписываться на события по определённому ключу (`subject`).
   - При создании подписки создаётся структура `subscription`, которая включает:
     - Канал сообщений (`msgChan`) для получения данных.
     - Канал завершения (`doneChan`) для управления жизненным циклом подписки.
   - Для каждой подписки запускается отдельная горутина, которая обрабатывает поступающие сообщения в порядке их публикации (FIFO).

2. **Публикация**
   - Метод `Publish` передаёт сообщение всем подписчикам, зарегистрированным на указанный ключ.
   - Сообщения доставляются через каналы подписчиков (`msgChan`), что обеспечивает асинхронность.

3. **Отписка**
   - Метод `Unsubscribe` удаляет подписку из списка активных подписок на ключ.
   - После вызова `Unsubscribe` подписчик перестаёт получать сообщения, а его ресурсы (каналы) освобождаются.

4. **Закрытие системы**
   - Метод `Close` завершает работу всей системы публикации и подписки.
   - Новый вызов методов `Subscribe` или `Publish` будет возвращать ошибку.
   - Все активные подписки завершатся корректно, а горутины будут остановлены.

---

## **Ключевые особенности**

- **FIFO-очередь:** Сообщения доставляются подписчикам в том порядке, в котором они были опубликованы.
- **Многопоточная безопасность:** Использование `sync.RWMutex` для управления доступом к общей структуре данных.
- **Асинхронность:** Обработка публикации и подписки происходит независимо, с использованием каналов.
- **Graceful Shutdown:** Поддержка корректного завершения работы с использованием контекста (`context.Context`).

---
